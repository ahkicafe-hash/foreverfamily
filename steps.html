<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steps Tracker | FOREVER FAMILY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

    <style>
        :root { --bg: #0d0d0d; --text: #F5F2EB; --gold: #D4AF37; --stone: #2A2A2A; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow-x: hidden; -webkit-font-smoothing: antialiased; }
        h1, h2, h3, h4, .font-condensed { font-family: 'Oswald', sans-serif; text-transform: uppercase; line-height: 1.1; }
        .bg-gold { background-color: var(--gold); }
        .text-gold { color: var(--gold); }
        .border-gold { border-color: var(--gold); }
        .border-stone { border-color: var(--stone); }
        .grain-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            pointer-events: none; z-index: 9999; opacity: 0.05;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* Live pulse */
        @keyframes livePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50%       { opacity: 0.4; transform: scale(0.85); }
        }
        @keyframes ringPulse {
            0%   { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(2.8); opacity: 0; }
        }
        .live-dot { animation: livePulse 1.4s ease-in-out infinite; }
        .live-ring {
            position: absolute; inset: 0; border-radius: 50%;
            border: 1.5px solid #D4AF37;
            animation: ringPulse 1.8s ease-out infinite;
        }

        /* Filter tab active */
        .filter-tab { transition: color 0.2s, border-color 0.2s; }
        .filter-tab.active { color: #D4AF37; border-bottom-color: #D4AF37; }

        /* Step row hover */
        .step-row { transition: background 0.2s; }
        .step-row:hover { background: #111; }

        /* Status badges */
        .badge-active    { color: #D4AF37; border-color: #D4AF37; }
        .badge-completed { color: #6b7280; border-color: #2A2A2A; }
        .badge-upcoming  { color: #F5F2EB; border-color: #2A2A2A; }

        /* Modal */
        #detail-modal { transition: opacity 0.25s; }

        /* Ticker scan line */
        @keyframes scanLine {
            0%   { top: -2px; }
            100% { top: 100%; }
        }
        .scan-line {
            position: absolute; left: 0; right: 0; height: 1px;
            background: rgba(212,175,55,0.15);
            animation: scanLine 4s linear infinite;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0d0d0d; }
        ::-webkit-scrollbar-thumb { background: #2A2A2A; }
    </style>
</head>
<body class="relative">

    <div class="grain-overlay"></div>

    <!-- NAV -->
    <nav class="fixed top-0 left-0 w-full p-6 z-50 flex justify-between items-center mix-blend-difference pointer-events-none">
        <div class="font-condensed text-2xl tracking-widest pointer-events-auto"><a href="index.html">FOREVER FAMILY</a></div>
        <div class="hidden md:flex gap-8 text-sm font-medium tracking-widest uppercase pointer-events-auto">
            <a href="about.html" class="hover:text-gold transition-colors">About</a>
            <a href="programmes.html" class="hover:text-gold transition-colors">Programmes</a>
            <a href="membership.html" class="hover:text-gold transition-colors">Membership</a>
            <a href="steps.html" class="text-gold">Tracker</a>
            <a href="portal.html" class="hover:text-gold transition-colors border border-stone px-3 py-1 hover:border-gold">Member Portal</a>
        </div>
        <button id="mobile-menu-btn" class="flex md:hidden flex-col justify-center items-end gap-[5px] w-8 h-8 pointer-events-auto" aria-label="Open navigation">
            <span class="ham-line block bg-white h-[1.5px] w-6 origin-center"></span>
            <span class="ham-line block bg-white h-[1.5px] w-6 origin-center"></span>
            <span class="ham-line block bg-white h-[1.5px] w-4 origin-center"></span>
        </button>
    </nav>

    <!-- MOBILE MENU -->
    <div id="mobile-menu" class="fixed inset-0 z-[9996] bg-[#0d0d0d] flex flex-col px-8 pt-7 pb-10 pointer-events-none overflow-y-auto" style="opacity:0">
        <div class="flex justify-between items-center mb-12">
            <div class="font-condensed text-2xl tracking-widest">FOREVER FAMILY</div>
            <button id="mobile-menu-close" class="flex flex-col justify-center items-center w-8 h-8" aria-label="Close navigation">
                <span class="block bg-white h-[1.5px] w-6 origin-center" style="transform:rotate(45deg) translateY(0.75px)"></span>
                <span class="block bg-white h-[1.5px] w-6 origin-center" style="transform:rotate(-45deg) translateY(-0.75px)"></span>
            </button>
        </div>
        <div class="border-b border-stone mb-6 pb-3">
            <span class="text-[10px] text-stone tracking-[0.3em] uppercase">Navigation</span>
        </div>
        <nav class="flex flex-col flex-grow">
            <a href="about.html"      class="mob-link font-condensed text-[14vw] text-white hover:text-gold transition-colors leading-none py-3 border-b border-stone border-opacity-30" style="opacity:0;transform:translateX(-24px)">ABOUT</a>
            <a href="programmes.html" class="mob-link font-condensed text-[14vw] text-white hover:text-gold transition-colors leading-none py-3 border-b border-stone border-opacity-30" style="opacity:0;transform:translateX(-24px)">PROGRAMMES</a>
            <a href="membership.html" class="mob-link font-condensed text-[14vw] text-white hover:text-gold transition-colors leading-none py-3 border-b border-stone border-opacity-30" style="opacity:0;transform:translateX(-24px)">MEMBERSHIP</a>
            <a href="steps.html"      class="mob-link font-condensed text-[14vw] text-gold leading-none py-3 border-b border-stone border-opacity-30" style="opacity:0;transform:translateX(-24px)">TRACKER</a>
            <a href="membership.html#join-form" class="mob-link font-condensed text-[14vw] text-white hover:text-gold transition-colors leading-none py-3" style="opacity:0;transform:translateX(-24px)">JOIN</a>
        </nav>
        <div class="border-t border-stone pt-6 mt-6 flex justify-between items-end">
            <a href="portal.html" class="mob-link text-xs tracking-widest uppercase text-stone hover:text-gold transition-colors" style="opacity:0;transform:translateX(-24px)">Member Portal →</a>
            <span class="text-[10px] text-stone tracking-widest uppercase opacity-40">PIA · FFCA · SOS</span>
        </div>
    </div>

    <!-- PAGE HEADER -->
    <section class="pt-36 pb-12 px-6 md:px-12 max-w-7xl mx-auto">
        <div class="flex items-center gap-4 mb-6">
            <!-- Live indicator -->
            <div class="relative w-3 h-3 flex-shrink-0">
                <div class="live-ring"></div>
                <div class="live-dot w-3 h-3 rounded-full bg-gold relative z-10"></div>
            </div>
            <span class="text-xs text-gold tracking-widest uppercase">Live Feed</span>
            <span class="text-[10px] text-stone tracking-widest" id="last-updated">Updating...</span>
        </div>

        <h1 class="font-condensed text-[13vw] md:text-[7vw] leading-none text-white mb-4">THE STEPS<br><span class="text-gold">TRACKER.</span></h1>
        <p class="text-gray-400 max-w-2xl leading-relaxed mb-12">Stepping is marching to support a vulnerable person anywhere in the UK. This tracker shows every active, completed, and upcoming step in real time.</p>

        <!-- Stats bar -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-0 border border-stone">
            <div class="stat-box border-r border-stone p-6 text-center">
                <div class="font-condensed text-4xl text-gold" id="stat-total">—</div>
                <div class="text-[10px] tracking-widest text-stone uppercase mt-1">Steps This Month</div>
            </div>
            <div class="stat-box border-r border-stone p-6 text-center">
                <div class="font-condensed text-4xl text-gold flex items-center justify-center gap-2" id="stat-active">
                    <span>—</span>
                </div>
                <div class="text-[10px] tracking-widest text-stone uppercase mt-1">Active Now</div>
            </div>
            <div class="stat-box border-r border-stone p-6 text-center">
                <div class="font-condensed text-4xl text-gold" id="stat-steppers">—</div>
                <div class="text-[10px] tracking-widest text-stone uppercase mt-1">Steppers Deployed</div>
            </div>
            <div class="stat-box p-6 text-center">
                <div class="font-condensed text-4xl text-gold" id="stat-cities">—</div>
                <div class="text-[10px] tracking-widest text-stone uppercase mt-1">Cities Covered</div>
            </div>
        </div>
    </section>

    <!-- FILTER TABS -->
    <div class="sticky top-[72px] z-40 bg-[#0d0d0d] border-b border-stone px-6 md:px-12">
        <div class="max-w-7xl mx-auto flex gap-0">
            <button data-filter="all"       class="filter-tab active font-condensed text-sm tracking-widest uppercase px-6 py-4 border-b-2 border-transparent text-white">ALL</button>
            <button data-filter="active"    class="filter-tab font-condensed text-sm tracking-widest uppercase px-6 py-4 border-b-2 border-transparent text-stone hover:text-white">ACTIVE</button>
            <button data-filter="upcoming"  class="filter-tab font-condensed text-sm tracking-widest uppercase px-6 py-4 border-b-2 border-transparent text-stone hover:text-white">UPCOMING</button>
            <button data-filter="completed" class="filter-tab font-condensed text-sm tracking-widest uppercase px-6 py-4 border-b-2 border-transparent text-stone hover:text-white">COMPLETED</button>
        </div>
    </div>

    <!-- STEPS LIST -->
    <main class="px-6 md:px-12 max-w-7xl mx-auto py-8">

        <!-- Loading state -->
        <div id="loading-state" class="py-24 text-center">
            <div class="relative w-8 h-8 mx-auto mb-6">
                <div class="live-ring"></div>
                <div class="live-dot w-8 h-8 rounded-full border border-gold"></div>
            </div>
            <p class="text-stone text-xs tracking-widest uppercase">Loading steps...</p>
        </div>

        <!-- Empty state -->
        <div id="empty-state" class="hidden py-24 text-center border border-stone">
            <p class="font-condensed text-2xl text-stone mb-2">NO STEPS FOUND</p>
            <p class="text-xs text-stone tracking-widest uppercase">Try a different filter</p>
        </div>

        <!-- Steps container -->
        <div id="steps-list" class="hidden">

            <!-- Active section -->
            <div id="section-active" class="hidden mb-2">
                <div class="flex items-center gap-3 py-4 border-b border-stone mb-0">
                    <div class="relative w-2.5 h-2.5 flex-shrink-0">
                        <div class="live-ring" style="animation-duration:1.6s"></div>
                        <div class="live-dot w-2.5 h-2.5 rounded-full bg-gold"></div>
                    </div>
                    <span class="font-condensed text-sm tracking-widest text-gold">ACTIVE NOW</span>
                    <span class="text-xs text-stone" id="active-count"></span>
                </div>
                <div id="active-rows"></div>
            </div>

            <!-- Upcoming section -->
            <div id="section-upcoming" class="hidden mb-2 mt-8">
                <div class="flex items-center gap-3 py-4 border-b border-stone mb-0">
                    <div class="w-2.5 h-2.5 rounded-full border border-stone flex-shrink-0"></div>
                    <span class="font-condensed text-sm tracking-widest text-white">UPCOMING</span>
                    <span class="text-xs text-stone" id="upcoming-count"></span>
                </div>
                <div id="upcoming-rows"></div>
            </div>

            <!-- Completed section -->
            <div id="section-completed" class="hidden mb-2 mt-8">
                <div class="flex items-center gap-3 py-4 border-b border-stone mb-0">
                    <svg width="10" height="10" viewBox="0 0 10 10" fill="none" class="flex-shrink-0"><circle cx="5" cy="5" r="4.5" stroke="#2A2A2A"/><path d="M2.5 5L4 6.5L7.5 3" stroke="#2A2A2A" stroke-width="1.2" stroke-linecap="round"/></svg>
                    <span class="font-condensed text-sm tracking-widest text-stone">COMPLETED</span>
                    <span class="text-xs text-stone" id="completed-count"></span>
                </div>
                <div id="completed-rows"></div>
            </div>

        </div>
    </main>

    <!-- DETAIL MODAL -->
    <div id="detail-modal" class="fixed inset-0 z-[9998] bg-[#0d0d0d] bg-opacity-90 flex items-center justify-center p-6 opacity-0 pointer-events-none">
        <div id="modal-panel" class="w-full max-w-2xl bg-[#0d0d0d] border border-gold p-8 md:p-12 relative overflow-hidden max-h-[90vh] overflow-y-auto" style="transform: translateY(20px) scale(0.96)">
            <div class="absolute top-0 left-0 w-6 h-6 border-t-2 border-l-2 border-gold m-3 pointer-events-none"></div>
            <div class="absolute top-0 right-0 w-6 h-6 border-t-2 border-r-2 border-gold m-3 pointer-events-none"></div>

            <!-- Scan line effect -->
            <div class="absolute inset-0 overflow-hidden pointer-events-none">
                <div class="scan-line"></div>
            </div>

            <button id="modal-close" class="absolute top-5 right-5 text-stone hover:text-gold transition-colors text-xs tracking-widest uppercase z-10">✕ CLOSE</button>

            <div id="modal-body" class="relative z-10">
                <!-- Filled by JS -->
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="py-24 px-6 md:px-12 bg-[#050505] relative overflow-hidden border-t border-stone flex flex-col items-center mt-16">
        <img src="images/logo-gold.png" alt="Forever Family" class="h-12 w-auto mb-12 opacity-50">
        <h2 class="font-condensed text-[8vw] md:text-[6vw] text-stone opacity-30 text-center leading-none mb-12">FOREVER MEANS WE STAY.</h2>
        <div class="flex gap-8 text-xs tracking-widest uppercase text-gray-500 mb-12 z-10 relative">
            <a href="#" class="hover:text-gold transition-colors">Instagram</a>
            <a href="#" class="hover:text-gold transition-colors">Patreon</a>
            <a href="membership.html#join-form" class="hover:text-gold transition-colors">Join</a>
            <a href="#" class="hover:text-gold transition-colors">Privacy</a>
        </div>
        <div class="text-xs tracking-widest text-stone uppercase mb-8 z-10 relative text-center">
            PIA — Public &nbsp;|&nbsp; FFCA — Confidential &nbsp;|&nbsp; SOS — Classified
        </div>
        <div class="w-full max-w-7xl h-[1px] bg-stone relative overflow-hidden z-10">
            <div class="absolute top-0 left-0 h-full bg-gold w-full transform -translate-x-full final-line"></div>
        </div>
    </footer>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        gsap.registerPlugin(ScrollTrigger);

        // ─── MOBILE MENU ─────────────────────────────────────────────────────
        const mobileMenu = document.getElementById('mobile-menu');
        const menuBtn    = document.getElementById('mobile-menu-btn');
        const menuClose  = document.getElementById('mobile-menu-close');
        const hamLines   = menuBtn.querySelectorAll('.ham-line');
        let menuOpen     = false;

        function openMenu() {
            menuOpen = true; document.body.style.overflow = 'hidden';
            gsap.set(mobileMenu, { pointerEvents: 'auto' });
            gsap.to(mobileMenu, { opacity: 1, duration: 0.25, ease: 'power2.out' });
            gsap.to('.mob-link', { x: 0, opacity: 1, duration: 0.55, stagger: 0.07, ease: 'power3.out', delay: 0.1 });
            gsap.to(hamLines[0], { rotation: 45,  y:  6.5, duration: 0.3, ease: 'power2.inOut' });
            gsap.to(hamLines[1], { opacity: 0, x: 8, duration: 0.2 });
            gsap.to(hamLines[2], { rotation: -45, y: -6.5, width: '1.5rem', duration: 0.3, ease: 'power2.inOut' });
        }
        function closeMenu() {
            menuOpen = false; document.body.style.overflow = '';
            gsap.to('.mob-link', { x: -24, opacity: 0, duration: 0.25, stagger: 0.04, ease: 'power2.in' });
            gsap.to(mobileMenu, { opacity: 0, duration: 0.3, ease: 'power2.in', delay: 0.15, onComplete: () => gsap.set(mobileMenu, { pointerEvents: 'none' }) });
            gsap.to(hamLines[0], { rotation: 0, y: 0, duration: 0.3, ease: 'power2.inOut' });
            gsap.to(hamLines[1], { opacity: 1, x: 0, duration: 0.2, delay: 0.1 });
            gsap.to(hamLines[2], { rotation: 0, y: 0, width: '1rem', duration: 0.3, ease: 'power2.inOut' });
        }
        menuBtn.addEventListener('click', () => menuOpen ? closeMenu() : openMenu());
        menuClose.addEventListener('click', closeMenu);
        document.querySelectorAll('.mob-link').forEach(l => { if (l.tagName === 'A') l.addEventListener('click', closeMenu); });

        // ─── FOOTER ───────────────────────────────────────────────────────────
        gsap.to(".final-line", { x: "0%", duration: 1.5, ease: "power2.out", scrollTrigger: { trigger: "footer", start: "top 80%" } });

        // ─── SEED DATA (fallback if server is offline) ───────────────────────
        const SEED = [
          { id:1, location:"Birmingham — Handsworth", city:"Birmingham", area:"Handsworth", steppers:12, status:"active", startTime:"2026-02-20T14:30:00", endTime:null, purpose:"Supporting a young person at risk of county lines exploitation. Family requested SOS team presence for a safe escort to temporary accommodation.", outcome:null, coordinatedBy:"SOS Team Alpha" },
          { id:2, location:"London (North) — Tottenham High Road", city:"London", area:"Tottenham", steppers:8, status:"active", startTime:"2026-02-20T15:00:00", endTime:null, purpose:"Community safety patrol in response to elevated tension following two incidents in the area this week.", outcome:null, coordinatedBy:"SOS Team Bravo" },
          { id:3, location:"Sheffield — Page Hall", city:"Sheffield", area:"Page Hall", steppers:6, status:"completed", startTime:"2026-02-18T18:00:00", endTime:"2026-02-18T21:30:00", purpose:"Welfare check and family support following G-Line referral. Young person at risk of exploitation.", outcome:"Family supported. Young person safely relocated. Referral made to specialist safeguarding service. Follow-up scheduled.", coordinatedBy:"SOS Team Charlie" },
          { id:4, location:"Birmingham — Aston", city:"Birmingham", area:"Aston", steppers:14, status:"completed", startTime:"2026-02-17T19:00:00", endTime:"2026-02-17T22:00:00", purpose:"Preventative patrol following community intelligence. Two groups reported to be planning a confrontation.", outcome:"No incident recorded. Presence deterred potential confrontation. Both groups dispersed peacefully. Intelligence filed.", coordinatedBy:"SOS Team Alpha" },
          { id:5, location:"London (East) — Hackney", city:"London", area:"Hackney", steppers:9, status:"completed", startTime:"2026-02-16T14:00:00", endTime:"2026-02-16T17:00:00", purpose:"Support step for a vulnerable adult experiencing homelessness and mental health crisis.", outcome:"Individual supported to emergency housing. Mental health first response administered. Liaison with council housing team completed.", coordinatedBy:"SOS Team Bravo" },
          { id:6, location:"Birmingham — Winson Green", city:"Birmingham", area:"Winson Green", steppers:7, status:"completed", startTime:"2026-02-14T20:00:00", endTime:"2026-02-14T23:00:00", purpose:"Evening safety patrol. High footfall area, weekly recurring operation.", outcome:"Patrol completed without incident. One welfare check conducted. Two young people signposted to FFCA programme.", coordinatedBy:"SOS Team Alpha" },
          { id:7, location:"Sheffield — Burngreave", city:"Sheffield", area:"Burngreave", steppers:5, status:"completed", startTime:"2026-02-13T17:30:00", endTime:"2026-02-13T20:00:00", purpose:"G-Line response. Mother reported son had not returned home for 3 days. Suspected exploitation situation.", outcome:"Young person located and safely returned home. Family support session conducted. Case referred to social services.", coordinatedBy:"SOS Team Charlie" },
          { id:8, location:"London (North) — Wood Green", city:"London", area:"Wood Green", steppers:11, status:"completed", startTime:"2026-02-11T18:00:00", endTime:"2026-02-11T21:30:00", purpose:"Community march in solidarity with local family affected by youth violence. Public visibility step.", outcome:"Step completed. 11 certified Steppers deployed. Community received positively. Local press present — media guidance issued.", coordinatedBy:"SOS Team Bravo" },
          { id:9, location:"Birmingham — Erdington", city:"Birmingham", area:"Erdington", steppers:10, status:"upcoming", startTime:"2026-02-23T17:00:00", endTime:null, purpose:"Planned community safety patrol following intelligence received at February FFCA session.", outcome:null, coordinatedBy:"SOS Team Alpha" },
          { id:10, location:"London (East) — Stratford", city:"London", area:"Stratford", steppers:8, status:"upcoming", startTime:"2026-02-24T18:30:00", endTime:null, purpose:"Support step requested via G-Line. Young person requiring safe escort to court hearing.", outcome:null, coordinatedBy:"SOS Team Bravo" },
          { id:11, location:"Sheffield — Firth Park", city:"Sheffield", area:"Firth Park", steppers:6, status:"upcoming", startTime:"2026-02-26T19:00:00", endTime:null, purpose:"Monthly Sheffield patrol. Recurring operation. New Steppers will observe and document.", outcome:null, coordinatedBy:"SOS Team Charlie" },
          { id:12, location:"Birmingham — Moseley", city:"Birmingham", area:"Moseley", steppers:15, status:"upcoming", startTime:"2026-03-01T14:00:00", endTime:null, purpose:"Community awareness march. Supporting local initiative against knife crime. Open to all certified Steppers and Bronze members.", outcome:null, coordinatedBy:"SOS Team Alpha" }
        ];

        // ─── HELPERS ─────────────────────────────────────────────────────────
        function relativeTime(isoString) {
            const date = new Date(isoString);
            const now  = new Date();
            const diff = date - now; // ms, positive = future
            const abs  = Math.abs(diff);
            const mins = Math.floor(abs / 60000);
            const hrs  = Math.floor(abs / 3600000);
            const days = Math.floor(abs / 86400000);
            if (diff < 0) {
                // past
                if (mins < 60)  return `${mins}m ago`;
                if (hrs  < 24)  return `${hrs}h ago`;
                if (days < 7)   return `${days}d ago`;
                return date.toLocaleDateString('en-GB', { day:'numeric', month:'short' });
            } else {
                // future
                if (mins < 60)  return `In ${mins}m`;
                if (hrs  < 24)  return `In ${hrs}h`;
                if (days < 7)   return `In ${days} day${days > 1 ? 's' : ''}`;
                return date.toLocaleDateString('en-GB', { day:'numeric', month:'short' });
            }
        }

        function formatDateTime(isoString) {
            if (!isoString) return '—';
            const d = new Date(isoString);
            return d.toLocaleDateString('en-GB', { weekday:'short', day:'numeric', month:'short', year:'numeric' })
                 + ' · '
                 + d.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' });
        }

        function formatDuration(start, end) {
            if (!end) return 'Ongoing';
            const ms = new Date(end) - new Date(start);
            const h  = Math.floor(ms / 3600000);
            const m  = Math.floor((ms % 3600000) / 60000);
            return h > 0 ? `${h}h ${m}m` : `${m}m`;
        }

        // ─── RENDER ───────────────────────────────────────────────────────────
        function renderRow(step) {
            const row = document.createElement('div');
            row.className = 'step-row border-b border-stone px-0 py-5 flex flex-col md:flex-row md:items-center gap-4 md:gap-0 cursor-default';
            row.dataset.id = step.id;
            row.dataset.status = step.status;

            const isActive    = step.status === 'active';
            const isCompleted = step.status === 'completed';

            // Status badge
            let badgeHtml = '';
            if (isActive) {
                badgeHtml = `<div class="flex items-center gap-2 md:w-28 flex-shrink-0">
                    <div class="relative w-2 h-2 flex-shrink-0"><div class="live-ring" style="animation-duration:1.6s"></div><div class="live-dot w-2 h-2 rounded-full bg-gold"></div></div>
                    <span class="text-[10px] tracking-widest uppercase text-gold font-medium">ACTIVE</span>
                </div>`;
            } else if (isCompleted) {
                badgeHtml = `<div class="flex items-center gap-2 md:w-28 flex-shrink-0">
                    <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><circle cx="6" cy="6" r="5.5" stroke="#2A2A2A"/><path d="M3 6L5 8L9 4" stroke="#2A2A2A" stroke-width="1.2" stroke-linecap="round"/></svg>
                    <span class="text-[10px] tracking-widest uppercase text-stone">DONE</span>
                </div>`;
            } else {
                badgeHtml = `<div class="flex items-center gap-2 md:w-28 flex-shrink-0">
                    <div class="w-2 h-2 rounded-full border border-stone flex-shrink-0"></div>
                    <span class="text-[10px] tracking-widest uppercase text-stone">UPCOMING</span>
                </div>`;
            }

            row.innerHTML = `
                ${badgeHtml}
                <div class="flex-grow min-w-0 md:pl-4">
                    <h3 class="font-condensed text-xl md:text-2xl text-white leading-tight ${isCompleted ? 'opacity-50' : ''}">${step.location}</h3>
                    <p class="text-xs text-stone tracking-widest uppercase mt-0.5">${step.coordinatedBy}</p>
                </div>
                <div class="flex items-center gap-6 md:gap-10 flex-shrink-0 md:ml-4">
                    <div class="text-center">
                        <div class="font-condensed text-2xl ${isActive ? 'text-gold' : isCompleted ? 'text-stone' : 'text-white'}">${step.steppers}</div>
                        <div class="text-[9px] tracking-widest text-stone uppercase">Steppers</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm ${isActive ? 'text-gold' : isCompleted ? 'text-stone' : 'text-gray-400'}">${relativeTime(step.startTime)}</div>
                        <div class="text-[9px] tracking-widest text-stone uppercase mt-0.5">${formatDateTime(step.startTime).split(' · ')[1]}</div>
                    </div>
                    <button class="more-btn flex-shrink-0 text-[10px] tracking-widest uppercase border border-stone px-4 py-2 hover:border-gold hover:text-gold transition-colors whitespace-nowrap" data-id="${step.id}">MORE →</button>
                </div>
            `;

            return row;
        }

        let allSteps = [];

        function updateStats(steps) {
            const active    = steps.filter(s => s.status === 'active');
            const completed = steps.filter(s => s.status === 'completed');
            const cities    = [...new Set(steps.map(s => s.city))].length;
            const steppers  = steps.reduce((a, s) => a + (s.steppers || 0), 0);

            gsap.to('#stat-total',    { innerText: steps.length,    snap: { innerText: 1 }, duration: 1.2, ease: 'power2.out' });
            gsap.to('#stat-active',   { innerText: active.length,   snap: { innerText: 1 }, duration: 1.2, ease: 'power2.out', delay: 0.1 });
            gsap.to('#stat-steppers', { innerText: steppers,        snap: { innerText: 1 }, duration: 1.4, ease: 'power2.out', delay: 0.2 });
            gsap.to('#stat-cities',   { innerText: cities,          snap: { innerText: 1 }, duration: 1,   ease: 'power2.out', delay: 0.15 });
        }

        function renderSteps(steps, filter) {
            const active    = steps.filter(s => s.status === 'active');
            const upcoming  = steps.filter(s => s.status === 'upcoming').sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
            const completed = steps.filter(s => s.status === 'completed').sort((a, b) => new Date(b.startTime) - new Date(a.startTime));

            const showActive    = filter === 'all' || filter === 'active';
            const showUpcoming  = filter === 'all' || filter === 'upcoming';
            const showCompleted = filter === 'all' || filter === 'completed';

            // Clear containers
            ['active-rows', 'upcoming-rows', 'completed-rows'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });

            let totalVisible = 0;

            if (showActive && active.length > 0) {
                document.getElementById('section-active').classList.remove('hidden');
                document.getElementById('active-count').textContent = `— ${active.length} step${active.length > 1 ? 's' : ''}`;
                active.forEach(s => document.getElementById('active-rows').appendChild(renderRow(s)));
                totalVisible += active.length;
            } else {
                document.getElementById('section-active').classList.add('hidden');
            }

            if (showUpcoming && upcoming.length > 0) {
                document.getElementById('section-upcoming').classList.remove('hidden');
                document.getElementById('upcoming-count').textContent = `— ${upcoming.length} scheduled`;
                upcoming.forEach(s => document.getElementById('upcoming-rows').appendChild(renderRow(s)));
                totalVisible += upcoming.length;
            } else {
                document.getElementById('section-upcoming').classList.add('hidden');
            }

            if (showCompleted && completed.length > 0) {
                document.getElementById('section-completed').classList.remove('hidden');
                document.getElementById('completed-count').textContent = `— ${completed.length} step${completed.length > 1 ? 's' : ''}`;
                completed.forEach(s => document.getElementById('completed-rows').appendChild(renderRow(s)));
                totalVisible += completed.length;
            } else {
                document.getElementById('section-completed').classList.add('hidden');
            }

            document.getElementById('loading-state').classList.add('hidden');

            if (totalVisible === 0) {
                document.getElementById('steps-list').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
            } else {
                document.getElementById('steps-list').classList.remove('hidden');
                document.getElementById('empty-state').classList.add('hidden');

                // Animate rows in
                gsap.fromTo('.step-row', { opacity: 0, x: -12 }, {
                    opacity: 1, x: 0, duration: 0.5, stagger: 0.04, ease: 'power2.out'
                });
            }

            // Bind MORE buttons
            document.querySelectorAll('.more-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const step = allSteps.find(s => String(s.id) === String(btn.dataset.id));
                    if (step) openModal(step);
                });
            });
        }

        // ─── MODAL ────────────────────────────────────────────────────────────
        const modal      = document.getElementById('detail-modal');
        const modalPanel = document.getElementById('modal-panel');

        function openModal(step) {
            const isActive    = step.status === 'active';
            const isCompleted = step.status === 'completed';
            const statusLabel = isActive ? '<span class="text-gold">● ACTIVE NOW</span>' : isCompleted ? '<span class="text-stone">✓ COMPLETED</span>' : '<span class="text-white">◎ UPCOMING</span>';

            document.getElementById('modal-body').innerHTML = `
                <div class="text-xs tracking-widest uppercase mb-6 flex items-center gap-3">
                    ${statusLabel}
                    <span class="text-stone">—</span>
                    <span class="text-stone">${step.coordinatedBy}</span>
                </div>

                <h2 class="font-condensed text-3xl md:text-5xl text-white mb-1">${step.location}</h2>
                <p class="text-stone text-sm tracking-widest uppercase mb-8">${step.city} — ${step.area}</p>

                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                    <div class="bg-[#111] border border-stone p-4">
                        <div class="font-condensed text-3xl text-gold">${step.steppers}</div>
                        <div class="text-[10px] tracking-widest text-stone uppercase mt-1">Steppers Deployed</div>
                    </div>
                    <div class="bg-[#111] border border-stone p-4">
                        <div class="font-condensed text-xl text-white">${relativeTime(step.startTime)}</div>
                        <div class="text-[10px] tracking-widest text-stone uppercase mt-1">Time</div>
                    </div>
                    <div class="bg-[#111] border border-stone p-4 col-span-2 md:col-span-1">
                        <div class="font-condensed text-xl text-white">${formatDuration(step.startTime, step.endTime)}</div>
                        <div class="text-[10px] tracking-widest text-stone uppercase mt-1">Duration</div>
                    </div>
                </div>

                <div class="border-t border-stone pt-6 mb-6">
                    <div class="text-[10px] tracking-widest text-gold uppercase mb-3">PURPOSE OF STEP</div>
                    <p class="text-gray-400 leading-relaxed text-sm">${step.purpose}</p>
                </div>

                <div class="text-[10px] tracking-widest text-stone uppercase mb-3">START TIME</div>
                <p class="text-sm text-gray-400 mb-6">${formatDateTime(step.startTime)}</p>

                ${step.endTime ? `<div class="text-[10px] tracking-widest text-stone uppercase mb-3">END TIME</div><p class="text-sm text-gray-400 mb-6">${formatDateTime(step.endTime)}</p>` : ''}

                ${step.outcome ? `
                <div class="border border-stone p-6 mt-2 relative">
                    <div class="absolute top-0 left-0 w-5 h-5 border-t-2 border-l-2 border-gold m-2 pointer-events-none"></div>
                    <div class="text-[10px] tracking-widest text-gold uppercase mb-3">OUTCOME</div>
                    <p class="text-sm text-gray-400 leading-relaxed">${step.outcome}</p>
                </div>` : ''}

                ${!step.outcome && step.status === 'upcoming' ? `
                <div class="border border-stone border-dashed p-6 mt-2 text-center">
                    <p class="text-xs text-stone tracking-widest uppercase">Outcome will be recorded after the step completes</p>
                </div>` : ''}
            `;

            document.body.style.overflow = 'hidden';
            gsap.set(modal, { pointerEvents: 'auto' });
            gsap.to(modal, { opacity: 1, duration: 0.25, ease: 'power2.out' });
            gsap.to(modalPanel, { y: 0, scale: 1, duration: 0.35, ease: 'back.out(1.4)' });
        }

        function closeModal() {
            gsap.to(modal, { opacity: 0, duration: 0.2, ease: 'power2.in', onComplete: () => {
                gsap.set(modal, { pointerEvents: 'none' });
                gsap.set(modalPanel, { y: 20, scale: 0.96 });
                document.body.style.overflow = '';
            }});
        }

        document.getElementById('modal-close').addEventListener('click', closeModal);
        modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

        // ─── FILTER TABS ─────────────────────────────────────────────────────
        let currentFilter = 'all';
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentFilter = tab.dataset.filter;
                renderSteps(allSteps, currentFilter);
            });
        });

        // ─── FETCH & REFRESH ─────────────────────────────────────────────────
        async function loadSteps() {
            try {
                const res = await fetch('/api/steps');
                if (!res.ok) throw new Error();
                const data = await res.json();
                allSteps = data.steps || SEED;
            } catch (_) {
                allSteps = SEED;
            }

            updateStats(allSteps);
            renderSteps(allSteps, currentFilter);

            const now = new Date();
            document.getElementById('last-updated').textContent =
                'Last updated ' + now.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
        }

        loadSteps();
        setInterval(loadSteps, 30000); // refresh every 30s
    });
    </script>
</body>
</html>
